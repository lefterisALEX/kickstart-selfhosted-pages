"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[567],{416:(e,t,n)=>{n.d(t,{A:()=>r});const r=n.p+"assets/images/oidc-github-428ac3c7ff5aebf53f0b2ca99d3077ac.png"},4377:(e,t,n)=>{n.d(t,{A:()=>r});const r=n.p+"assets/images/iam-role-9bc82bbf50e98f8e0d8d31fce3b707a8.png"},4479:(e,t,n)=>{n.d(t,{A:()=>r});const r=n.p+"assets/images/github-set-variables-f31c9eab0e6ed15594e34839343f344d.png"},4994:(e,t,n)=>{n.d(t,{A:()=>r});const r=n.p+"assets/images/iam-provider-3bf49c4b0e62a8e90132f84cfc31f618.png"},6885:(e,t,n)=>{n.d(t,{A:()=>r});const r=n.p+"assets/images/aws-oidc-role-7a61228c549d9bd8367a6a07a631ccbc.png"},8453:(e,t,n)=>{n.d(t,{R:()=>o,x:()=>a});var r=n(6540);const s={},i=r.createContext(s);function o(e){const t=r.useContext(i);return r.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),r.createElement(i.Provider,{value:t},e.children)}},8565:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>a,default:()=>l,frontMatter:()=>o,metadata:()=>r,toc:()=>d});const r=JSON.parse('{"id":"Preparation/aws","title":"Terraform state - AWS","description":"AWS S3 is used as backend to store the terraform state. If you preffer a different backend please refer to  terragrunt documentation.","source":"@site/docs/Preparation/aws.md","sourceDirName":"Preparation","slug":"/Preparation/aws","permalink":"/kickstart-selfhosted-pages/Preparation/aws","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"sidebar_position":4},"sidebar":"defaultSidebar","previous":{"title":"VPN - Tailscale","permalink":"/kickstart-selfhosted-pages/Preparation/tailscale"},"next":{"title":"DNS & TLS certificates - Cloudflare/Let\'s Encrypt","permalink":"/kickstart-selfhosted-pages/Preparation/Cloudflare"}}');var s=n(4848),i=n(8453);const o={sidebar_position:4},a="Terraform state - AWS",c={},d=[{value:"Github Variables",id:"github-variables",level:2},{value:"IAM Policy",id:"iam-policy",level:2},{value:"IAM Role",id:"iam-role",level:2},{value:"Identity Provider",id:"identity-provider",level:2}];function h(e){const t={a:"a",admonition:"admonition",br:"br",code:"code",h1:"h1",h2:"h2",header:"header",img:"img",p:"p",pre:"pre",strong:"strong",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.header,{children:(0,s.jsx)(t.h1,{id:"terraform-state---aws",children:"Terraform state - AWS"})}),"\n",(0,s.jsxs)(t.p,{children:["AWS S3 is used as backend to store the terraform state. If you preffer a different backend please refer to  ",(0,s.jsx)(t.a,{href:"https://terragrunt.gruntwork.io/docs/features/state-backend/",children:"terragrunt"})," documentation.\nYou will need to modify the remote_state code in the parent ",(0,s.jsx)(t.code,{children:"terrarunt.hcl"})," file."]}),"\n",(0,s.jsx)(t.h2,{id:"github-variables",children:"Github Variables"}),"\n",(0,s.jsxs)(t.p,{children:["Github runners need permissions to create an AWS S3 bucket where they store & retrieve the terraform state,we do it using ",(0,s.jsx)(t.a,{href:"https://docs.github.com/en/actions/security-for-github-actions/security-hardening-your-deployments/configuring-openid-connect-in-amazon-web-services",children:"OpenID Connect"})]}),"\n",(0,s.jsx)(t.p,{children:"Create the three required variables in github which will be used to create an AWS S3 bucket to store the terraform state."}),"\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.strong,{children:"AWS_ACCOUNT_ID"})," -> Your AWS ACCOUNT ID.",(0,s.jsx)(t.br,{}),"\n",(0,s.jsx)(t.strong,{children:"AWS_REGION"}),"  -> The AWS Region you want the bucket to be created.",(0,s.jsx)(t.br,{}),"\n",(0,s.jsx)(t.strong,{children:"AWS_S3_BUCKET"})," -> The AWS S3 bucket name."]}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{src:n(4479).A+"",width:"1592",height:"920"})}),"\n",(0,s.jsx)(t.h2,{id:"iam-policy",children:"IAM Policy"}),"\n",(0,s.jsx)(t.p,{children:"First we need to create an IAM Policy with the following permissions attached. Those are the permissions that the github runners will get when they assume the IAM role we are going to create later."}),"\n",(0,s.jsx)(t.admonition,{type:"info",children:(0,s.jsx)(t.p,{children:"Do not forget to replace the Resource strings to include your bucket name from the previous step."})}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{children:'{\n    "Version": "2012-10-17",\n    "Statement": [\n        {\n            "Sid": "VisualEditor1",\n            "Effect": "Allow",\n            "Action": [\n                "s3:*",\n                "s3:CreateBucket"\n            ],\n            "Resource": [\n                "arn:aws:s3:::terraform-state-kickstart-demo/*", \n                "arn:aws:s3:::terraform-state-kickstart-demo*"\n            ]\n        }\n    ]\n}\n'})}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{src:n(8707).A+"",width:"1507",height:"893"})}),"\n",(0,s.jsx)(t.h2,{id:"iam-role",children:"IAM Role"}),"\n",(0,s.jsxs)(t.p,{children:["Then we create a new IAM Role called ",(0,s.jsx)(t.strong,{children:"github-oidc"})," with the following ",(0,s.jsx)(t.strong,{children:"Custom Trust Policy"}),"."]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{children:'{\n    "Version": "2012-10-17",\n    "Statement": [\n        {\n            "Effect": "Allow",\n            "Principal": {\n                "Federated": "arn:aws:iam::123456789000:oidc-provider/token.actions.githubusercontent.com"\n            },\n            "Action": "sts:AssumeRoleWithWebIdentity",\n            "Condition": {\n                "StringEquals": {\n                    "token.actions.githubusercontent.com:aud": "sts.amazonaws.com"\n                },\n                "StringLike": {\n                    "token.actions.githubusercontent.com:sub": [\n                        "repo:homelabs757/my-selfhosted-services:*"\n                    ]\n                }\n            }\n        }\n    ]\n}\n'})}),"\n",(0,s.jsx)(t.admonition,{type:"info",children:(0,s.jsx)(t.p,{children:"Replace the AWS Account ID in Principal with your AWS account ID and also the repository with your own repository."})}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{src:n(4377).A+"",width:"1507",height:"893"})}),"\n",(0,s.jsxs)(t.p,{children:["Press next and in the ",(0,s.jsx)(t.strong,{children:"Add Permissions"})," select the IAM policy you created earlier. Give a new to the IAM role and press Create.\n",(0,s.jsx)(t.img,{src:n(9833).A+"",width:"1507",height:"893"})]}),"\n",(0,s.jsx)(t.admonition,{type:"info",children:(0,s.jsxs)(t.p,{children:["Make sure the name of the role is ",(0,s.jsx)(t.strong,{children:"github-oidc"})," otherwise is not going to work."]})}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{src:n(6885).A+"",width:"1263",height:"844"})}),"\n",(0,s.jsx)(t.h2,{id:"identity-provider",children:"Identity Provider"}),"\n",(0,s.jsxs)(t.p,{children:['Create a new Identity Provider of type "OpenID Connect" with the following Provider URL and Audience.',(0,s.jsx)(t.br,{}),"\n",(0,s.jsx)(t.strong,{children:"Provider URL:"})," ",(0,s.jsx)(t.code,{children:"https://token.actions.githubusercontent.com"}),(0,s.jsx)(t.br,{}),"\n",(0,s.jsx)(t.strong,{children:"Audience:"})," ",(0,s.jsx)(t.code,{children:"sts.amazonaws.com"})]}),"\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.img,{src:n(4994).A+"",width:"1507",height:"893"}),"\n",(0,s.jsx)(t.img,{src:n(416).A+"",width:"1507",height:"893"})]})]})}function l(e={}){const{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(h,{...e})}):h(e)}},8707:(e,t,n)=>{n.d(t,{A:()=>r});const r=n.p+"assets/images/iam-policy-57643a2fd32909b5f0a7cfee583ab072.png"},9833:(e,t,n)=>{n.d(t,{A:()=>r});const r=n.p+"assets/images/iam-role-select-policy-1af34e9b5c3bc762821f24f81c4ca5a6.png"}}]);