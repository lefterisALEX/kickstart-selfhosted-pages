"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[804],{174:(e,t,n)=>{n.d(t,{A:()=>i});const i=n.p+"assets/images/infisical-root-secrets-aa5f859a5c6c87372527494eae57f9b4.png"},2049:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>a,contentTitle:()=>c,default:()=>h,frontMatter:()=>o,metadata:()=>i,toc:()=>l});const i=JSON.parse('{"id":"how_it_works","title":"How it works","description":"General idea","source":"@site/docs/how_it_works.md","sourceDirName":".","slug":"/how_it_works","permalink":"/kickstart-selfhosted-pages/how_it_works","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"sidebar_position":2},"sidebar":"defaultSidebar","previous":{"title":"Introduction","permalink":"/kickstart-selfhosted-pages/"},"next":{"title":"Costs","permalink":"/kickstart-selfhosted-pages/costs"}}');var r=n(4848),s=n(8453);const o={sidebar_position:2},c="How it works",a={},l=[{value:"General idea",id:"general-idea",level:2},{value:"Containers Deployment",id:"containers-deployment",level:2},{value:"Deployr script",id:"deployr-script",level:3},{value:"Docker-compose structure",id:"docker-compose-structure",level:3},{value:"root docker-compose file",id:"root-docker-compose-file",level:4},{value:"application specific docker-compose file",id:"application-specific-docker-compose-file",level:4},{value:"Persistent Storage",id:"persistent-storage",level:2},{value:"Secrets",id:"secrets",level:2},{value:"Infrastructure secrets",id:"infrastructure-secrets",level:3},{value:"Application specific secrets",id:"application-specific-secrets",level:3}];function d(e){const t={a:"a",admonition:"admonition",br:"br",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(t.header,{children:(0,r.jsx)(t.h1,{id:"how-it-works",children:"How it works"})}),"\n",(0,r.jsx)(t.h2,{id:"general-idea",children:"General idea"}),"\n",(0,r.jsx)(t.p,{children:"The objective is to establish a fully automated deployment process that provisions all necessary infrastructure and containers as specified in the docker-compose.yaml files through a continuous integration/continuous deployment (CI/CD) pipeline. Aside from a few manual steps outlined in the Preparation section, all configurations will be defined in code."}),"\n",(0,r.jsx)(t.h2,{id:"containers-deployment",children:"Containers Deployment"}),"\n",(0,r.jsxs)(t.p,{children:["When the setup is deployed a VPS will be launched in Hetzner were your containers will run.\nIn this VPS your github repository will be also cloned under ",(0,r.jsx)(t.code,{children:"/root/deployr/"})]}),"\n",(0,r.jsx)(t.h3,{id:"deployr-script",children:"Deployr script"}),"\n",(0,r.jsx)(t.p,{children:"The deployr script is executed periodically (every 3 minutes) and taking care of the following actions:"}),"\n",(0,r.jsxs)(t.ol,{children:["\n",(0,r.jsx)(t.li,{children:"Fetch latest code from your repository."}),"\n",(0,r.jsx)(t.li,{children:"Fetch all secrets from your infisical project and save them locally in the VPS (see Secrets section below for more info)"}),"\n",(0,r.jsxs)(t.li,{children:["If there is any new commit detected then ",(0,r.jsx)(t.code,{children:"docker compose up -d /root/deployr/containers-host/apps/docker-compose.yaml"})," is executed"]}),"\n"]}),"\n",(0,r.jsx)(t.h3,{id:"docker-compose-structure",children:"Docker-compose structure"}),"\n",(0,r.jsxs)(t.p,{children:["Instead of having a large ",(0,r.jsx)(t.code,{children:"docker-compose.yaml"})," file where we define all the services, we use instead the ",(0,r.jsx)(t.code,{children:"include"})," command to split the configuration in multiple files."]}),"\n",(0,r.jsxs)(t.p,{children:["Below a structure of the folder ",(0,r.jsx)(t.code,{children:"containers-host/apps"})," in your repository."]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"\u251c\u2500\u2500 docker-compose.yaml\n\u251c\u2500\u2500 traefik\n\u2502   \u2514\u2500\u2500 docker-compose.yaml\n\u2514\u2500\u2500 uptime\n    \u2514\u2500\u2500 docker-compose.yaml\n"})}),"\n",(0,r.jsx)(t.h4,{id:"root-docker-compose-file",children:"root docker-compose file"}),"\n",(0,r.jsxs)(t.p,{children:["In this structure there is a main ",(0,r.jsx)(t.code,{children:"docker-compose.yaml"})," file which is used to configure:"]}),"\n",(0,r.jsxs)(t.ol,{children:["\n",(0,r.jsxs)(t.li,{children:["Which other ",(0,r.jsx)(t.code,{children:"docker-compose.yaml"})," files should be included, so in other words which other services should be enabled."]}),"\n",(0,r.jsx)(t.li,{children:"The docker network name and subnet."}),"\n"]}),"\n",(0,r.jsxs)(t.p,{children:["example of a root ",(0,r.jsx)(t.code,{children:"docker-compose.yaml"})," file"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:'version: "3"\ninclude:\n  - ./traefik/docker-compose.yaml\n  - ./docker-backup/docker-compose.yaml\n  - ./dashy/docker-compose.yaml\n  - ./uptime/docker-compose.yaml\nnetworks:\n  private_network:\n    name: private_network\n    driver: bridge\n    ipam:\n      config:\n        - subnet: 172.29.1.0/24\n'})}),"\n",(0,r.jsx)(t.h4,{id:"application-specific-docker-compose-file",children:"application specific docker-compose file"}),"\n",(0,r.jsxs)(t.p,{children:["All applications in this example (traefik/docker-backup/dashy/uptime) should have then their own dedicated  ",(0,r.jsx)(t.code,{children:"docker-compose.yaml"})," file under a specific directory.",(0,r.jsx)(t.br,{}),"\n","For instance for the traefik application the ",(0,r.jsx)(t.code,{children:"docker-compose.yaml"})," is the ",(0,r.jsx)(t.code,{children:"traefik/docker-compose.yaml"})]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:'version: "3.8"\n\nname: traefik\n\nservices:\n  traefik:\n    image: traefik:v3.3\n    container_name: traefik\n    ports:\n      - 80:80\n      - 443:443\n      - 8080:8080\n    networks:\n      private_network:\n    env_file:\n      - .secrets\n    volumes:\n      - /var/run/docker.sock:/var/run/docker.sock:ro\n      - /mnt/data/traefik/letsencrypt:/letsencrypt\n    command:\n      - "--api=true"\n      - "--api.dashboard=true"\n      - "--providers.docker=true"\n      - "--providers.docker.exposedbydefault=false"\n      - "--entrypoints.web.address=:80"\n      - "--entrypoints.websecure.address=:443"\n      - "--entrypoints.web.http.redirections.entryPoint.to=websecure"\n      - "--certificatesresolvers.letsencrypt.acme.dnschallenge=true"\n      - "--certificatesresolvers.letsencrypt.acme.dnschallenge.provider=cloudflare"\n      - "--certificatesresolvers.letsencrypt.acme.email=${EMAIL}"\n      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"\n    labels:\n      - "traefik.enable=true"\n      - "traefik.http.routers.dashboard.entrypoints=websecure"\n      - "traefik.http.routers.dashboard.tls.certresolver=letsencrypt"\n      - "traefik.http.routers.dashboard.rule=Host(`dashboard.${DOMAIN}`) && (PathPrefix(`/api`) || PathPrefix(`/dashboard`))"\n      - "traefik.http.routers.dashboard.service=api@internal"\n    restart: always\n'})}),"\n",(0,r.jsx)(t.h2,{id:"persistent-storage",children:"Persistent Storage"}),"\n",(0,r.jsxs)(t.p,{children:["The setup provision a volume in Hetzner which is attached in the VPS under ",(0,r.jsx)(t.code,{children:"/mnt/data"}),". Any data that need to persist is highly recommeneded to be stored there.\nThis can be done by mounting the path inside the container under ",(0,r.jsx)(t.code,{children:"/mnt/data/application_name"}),".",(0,r.jsx)(t.br,{}),"\n","By storing persistent data in an external volume, the data remains unaffected by the lifecycle of the VPS. This means that if the VPS is replaced, the data in the external volume will not be lost. Additionally, the external volume comes with delete protection enabled by default, ensuring that it cannot be deleted without first disabling this protection."]}),"\n",(0,r.jsx)(t.admonition,{type:"tip",children:(0,r.jsxs)(t.p,{children:["It is not necessary to store application-specific persistent data under the directory ",(0,r.jsx)(t.code,{children:"/mnt/data/application_name"}),". For instance, Traefik's persistent data can reside in any subdirectory within /mnt/data. However, it is recommended to maintain a structured organization that suits your needs for better management and accessibility."]})}),"\n",(0,r.jsx)(t.h2,{id:"secrets",children:"Secrets"}),"\n",(0,r.jsx)(t.h3,{id:"infrastructure-secrets",children:"Infrastructure secrets"}),"\n",(0,r.jsxs)(t.p,{children:["All secrets, except those use by the containers are storeed as ",(0,r.jsx)(t.a,{href:"Preparation/Github#github-secret",children:"repository secrets in Github"}),", so they can be consumed during the execution of the pipeline."]}),"\n",(0,r.jsx)(t.h3,{id:"application-specific-secrets",children:"Application specific secrets"}),"\n",(0,r.jsxs)(t.p,{children:["Secrets that need to be used inside the containers are stored as external secrets at ",(0,r.jsx)(t.a,{href:"https://infisical.com/",children:"infisical"}),".\nAll secrets that are stored in the root directory of infisical are going to be stored in the VPS in an ",(0,r.jsx)(t.code,{children:".env"})," file along with the root ",(0,r.jsx)(t.code,{children:"docker-compose.yaml"})," . That way those secrets will be available to all containers as environment variables.\n",(0,r.jsx)(t.img,{src:n(174).A+"",width:"961",height:"540"})]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-yaml",children:"\u251c\u2500\u2500 docker-compose.yaml\n\u251c\u2500\u2500 .env #This file will contain the secrets highlighted above\n\u251c\u2500\u2500 traefik\n\u2502   \u2514\u2500\u2500 docker-compose.yaml\n\u2514\u2500\u2500 uptime\n    \u2514\u2500\u2500 docker-compose.yaml\n"})}),"\n",(0,r.jsx)(t.admonition,{type:"info",children:(0,r.jsxs)(t.p,{children:["Downloading the secrets and storing them in the ",(0,r.jsx)(t.code,{children:".env"})," file is done by the deployr script and this action is executed periodically."]})}),"\n",(0,r.jsxs)(t.p,{children:["All secrets stored in Infisical under the ",(0,r.jsx)(t.code,{children:"traefik"})," directory will be copied to the file ",(0,r.jsx)(t.code,{children:"./traefik/.secrets"}),", making them accessible to the Traefik containers as defined in ",(0,r.jsx)(t.code,{children:"./traefik/docker-compose.yaml"}),".\n",(0,r.jsx)(t.img,{src:n(8085).A+"",width:"961",height:"540"})]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-yaml",children:"\u251c\u2500\u2500 docker-compose.yaml\n\u251c\u2500\u2500 .env\n\u251c\u2500\u2500 traefik\n\u2502   \u251c\u2500\u2500 docker-compose.yaml\n\u2502   \u2514\u2500\u2500 .secrets #This file will contain the secrets highlighted above\n\u2514\u2500\u2500 uptime\n    \u2514\u2500\u2500 docker-compose.yaml\n"})}),"\n",(0,r.jsx)(t.admonition,{type:"tip",children:(0,r.jsxs)(t.p,{children:["To create a ",(0,r.jsx)(t.code,{children:".secrets"})," file for each application, we can create a corresponding directory in Infisical with the same name. For example, to create a ",(0,r.jsx)(t.code,{children:".secrets"})," file for the ",(0,r.jsx)(t.code,{children:"uptime"})," application, we need to create an ",(0,r.jsx)(t.code,{children:"uptime"})," directory in Infisical and store the relevant secrets there. These secrets will then be saved in the file ",(0,r.jsx)(t.code,{children:"./uptime/.secrets"}),"."]})})]})}function h(e={}){const{wrapper:t}={...(0,s.R)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},8085:(e,t,n)=>{n.d(t,{A:()=>i});const i=n.p+"assets/images/infisical-traefik-secret-ce72bf241eaa52e0627d1ea55173c1a8.png"},8453:(e,t,n)=>{n.d(t,{R:()=>o,x:()=>c});var i=n(6540);const r={},s=i.createContext(r);function o(e){const t=i.useContext(s);return i.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function c(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),i.createElement(s.Provider,{value:t},e.children)}}}]);